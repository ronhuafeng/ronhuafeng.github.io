<!doctype html><html lang=zh-cn><head><title>é—œæ–¼ LLVM Pass çš„ä¸€äº›åŸºæœ¬æ“ä½œ // ä¸æ˜¯è¿½é£å°‘å¹´</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="bef0rewind"><meta name=description content><link rel=stylesheet href=https://blog.formalscience.com/css/main.min.7399fa7ec2205ae468fae43bdd5857841a2cd7eb35f0c8562b0e111b9d44c95f.css><link rel=stylesheet href=/css/style.css><script src=/javascripts/audio-player.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="é—œæ–¼ LLVM Pass çš„ä¸€äº›åŸºæœ¬æ“ä½œ"><meta name=twitter:description content="é—œæ–¼ LLVM Pass çš„ä¸€äº›åŸºæœ¬æ“ä½œ è¨˜éŒ„ä¸€ä¸‹é—œæ–¼ LLVM Pass çš„ä¸€äº›æ“ä½œï¼Œä¸»è¦æ˜¯ä¸€äº›é…ç½®å·¥ä½œã€‚é›–ç„¶ç›®å‰çš„å·¥ä½œæµç¨‹ä¸æ˜¯å¾ˆå„ªé›…ï¼Œä½†æ˜¯å¯ä»¥è‡ªå®šç¾© LLVM Pass çš„è™•ç†éç¨‹ï¼Œé€šéé€²ä¸€æ­¥å­¸ç¿’å¯ä»¥ä½œå‡ºæ›´æœ‰æ„æ€çš„æ±è¥¿ã€‚
æœ¬æ–‡çš„ GitHub åœ°å€ï¼š https://github.com/ronhuafeng/HandleLLVMPassBasic ï¼Œæœ‰é€™ç¯‡æ–‡ç« å’Œä¸€äº›ç²—ç³™çš„æºä»£ç¢¼ã€‚
ç¶²çµ¡ä¸Šå·²ç¶“æœ‰ä¸€ä¸‹æ•™ç¨‹äº†ï¼Œæˆ‘ä¹Ÿåƒè€ƒäº†é€™äº›æ•™ç¨‹ã€‚
ä½¿ç”¨ clang åŠ è¼‰ LLVM çš„ Pass LLVM - Run Own Pass automatically with clang stack overflow ä¸Šçš„å›ç­”ï¼Œè©¦åœ–ä½¿ç”¨ clang åŠ è¼‰ LLVM çš„ Passã€‚ Polly åº“åŠ è¼‰ LLVM Pass çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªè§£å†³æ€è·¯ï¼Œæˆ‘åƒè€ƒäº†é€™è£é¢çš„å¾ˆå¤šï¼šLoad Polly into clang and automatically run it at -O3 å…·ä½“çš„åŠ è¼‰éç¨‹åƒè€ƒäº† Adrian Sampson åšå®¢ Run an LLVM Pass Automatically with Clang ä¸­æåˆ°çš„æ“ä½œã€‚ å·¥ä½œæµç¨‹ æº–å‚™å·¥ä½œ å°‡ç³»çµ±ä¸­è‡ªå¸¶çš„ llvm å’Œ clang éƒ½å¸è¼‰æ‰ï¼Œä¿è­‰ llvm å’Œ clang ç‰ˆæœ¬çš„ä¸€è‡´æ€§ï¼ˆéå¸¸é‡è¦ï¼‰ï¼Œå³ä¿è­‰ä½¿ç”¨çš„ clang å’Œ ç·¨è­¯å‡ºçš„ Pass çš„å‹•æ…‹éˆæ¥åº«æ–‡ä»¶ ."><meta property="og:title" content="é—œæ–¼ LLVM Pass çš„ä¸€äº›åŸºæœ¬æ“ä½œ"><meta property="og:description" content="é—œæ–¼ LLVM Pass çš„ä¸€äº›åŸºæœ¬æ“ä½œ è¨˜éŒ„ä¸€ä¸‹é—œæ–¼ LLVM Pass çš„ä¸€äº›æ“ä½œï¼Œä¸»è¦æ˜¯ä¸€äº›é…ç½®å·¥ä½œã€‚é›–ç„¶ç›®å‰çš„å·¥ä½œæµç¨‹ä¸æ˜¯å¾ˆå„ªé›…ï¼Œä½†æ˜¯å¯ä»¥è‡ªå®šç¾© LLVM Pass çš„è™•ç†éç¨‹ï¼Œé€šéé€²ä¸€æ­¥å­¸ç¿’å¯ä»¥ä½œå‡ºæ›´æœ‰æ„æ€çš„æ±è¥¿ã€‚
æœ¬æ–‡çš„ GitHub åœ°å€ï¼š https://github.com/ronhuafeng/HandleLLVMPassBasic ï¼Œæœ‰é€™ç¯‡æ–‡ç« å’Œä¸€äº›ç²—ç³™çš„æºä»£ç¢¼ã€‚
ç¶²çµ¡ä¸Šå·²ç¶“æœ‰ä¸€ä¸‹æ•™ç¨‹äº†ï¼Œæˆ‘ä¹Ÿåƒè€ƒäº†é€™äº›æ•™ç¨‹ã€‚
ä½¿ç”¨ clang åŠ è¼‰ LLVM çš„ Pass LLVM - Run Own Pass automatically with clang stack overflow ä¸Šçš„å›ç­”ï¼Œè©¦åœ–ä½¿ç”¨ clang åŠ è¼‰ LLVM çš„ Passã€‚ Polly åº“åŠ è¼‰ LLVM Pass çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªè§£å†³æ€è·¯ï¼Œæˆ‘åƒè€ƒäº†é€™è£é¢çš„å¾ˆå¤šï¼šLoad Polly into clang and automatically run it at -O3 å…·ä½“çš„åŠ è¼‰éç¨‹åƒè€ƒäº† Adrian Sampson åšå®¢ Run an LLVM Pass Automatically with Clang ä¸­æåˆ°çš„æ“ä½œã€‚ å·¥ä½œæµç¨‹ æº–å‚™å·¥ä½œ å°‡ç³»çµ±ä¸­è‡ªå¸¶çš„ llvm å’Œ clang éƒ½å¸è¼‰æ‰ï¼Œä¿è­‰ llvm å’Œ clang ç‰ˆæœ¬çš„ä¸€è‡´æ€§ï¼ˆéå¸¸é‡è¦ï¼‰ï¼Œå³ä¿è­‰ä½¿ç”¨çš„ clang å’Œ ç·¨è­¯å‡ºçš„ Pass çš„å‹•æ…‹éˆæ¥åº«æ–‡ä»¶ ."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.formalscience.com/2016/01/09/2016-01-09_%E9%97%9C%E6%96%BC_llvm_pass_%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-01-09T21:46:48+00:00"><meta property="article:modified_time" content="2016-01-09T21:46:48+00:00"></head><body><header class=app-header><a href=https://blog.formalscience.com/><img class=app-header-avatar src=/avatar.jpg alt=bef0rewind></a>
<span class=app-header-title>ä¸æ˜¯è¿½é£å°‘å¹´</span><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/posts>Blogs</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/douban>è±†ç“£æ–‡ç« å¤‡ä»½</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/wechat-blogs>å¾®ä¿¡å…¬ä¼—å·</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/categories/>Categories</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/tags/>Tags</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/about/>About</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/feed.xml>RSS</a></nav><p>å½“ä½ åœ¨è¿½ç€é£ï¼Œé£ä¹Ÿåœ¨æ¨ç€ä½ </p><div class=app-header-social><a href=https://github.com/ronhuafeng target=_blank rel="noreferrer noopener me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>æˆ‘çš„ GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>é—œæ–¼ LLVM Pass çš„ä¸€äº›åŸºæœ¬æ“ä½œ</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 9, 2016</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read</div></div></header><div class=post-content><h1 id=é—œæ–¼-llvm-pass-çš„ä¸€äº›åŸºæœ¬æ“ä½œ>é—œæ–¼ LLVM Pass çš„ä¸€äº›åŸºæœ¬æ“ä½œ</h1><p>è¨˜éŒ„ä¸€ä¸‹é—œæ–¼ LLVM Pass çš„ä¸€äº›æ“ä½œï¼Œä¸»è¦æ˜¯ä¸€äº›é…ç½®å·¥ä½œã€‚é›–ç„¶ç›®å‰çš„å·¥ä½œæµç¨‹ä¸æ˜¯å¾ˆå„ªé›…ï¼Œä½†æ˜¯å¯ä»¥è‡ªå®šç¾© LLVM Pass çš„è™•ç†éç¨‹ï¼Œé€šéé€²ä¸€æ­¥å­¸ç¿’å¯ä»¥ä½œå‡ºæ›´æœ‰æ„æ€çš„æ±è¥¿ã€‚</p><p>æœ¬æ–‡çš„ GitHub åœ°å€ï¼š <a href=https://github.com/ronhuafeng/HandleLLVMPassBasic>https://github.com/ronhuafeng/HandleLLVMPassBasic</a> ï¼Œæœ‰é€™ç¯‡æ–‡ç« å’Œä¸€äº›ç²—ç³™çš„æºä»£ç¢¼ã€‚</p><p>ç¶²çµ¡ä¸Šå·²ç¶“æœ‰ä¸€ä¸‹æ•™ç¨‹äº†ï¼Œæˆ‘ä¹Ÿåƒè€ƒäº†é€™äº›æ•™ç¨‹ã€‚</p><h2 id=ä½¿ç”¨-clang-åŠ è¼‰-llvm-çš„-pass>ä½¿ç”¨ clang åŠ è¼‰ LLVM çš„ Pass</h2><ul><li><a href=http://stackoverflow.com/questions/23130821/llvm-run-own-pass-automatically-with-clang>LLVM - Run Own Pass automatically with clang</a>
stack overflow ä¸Šçš„å›ç­”ï¼Œè©¦åœ–ä½¿ç”¨ clang åŠ è¼‰ LLVM çš„ Passã€‚</li><li>Polly åº“åŠ è¼‰ LLVM Pass çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªè§£å†³æ€è·¯ï¼Œæˆ‘åƒè€ƒäº†é€™è£é¢çš„å¾ˆå¤šï¼š<a href=http://polly.llvm.org/example_load_Polly_into_clang.html>Load Polly into clang and automatically run it at -O3</a></li><li>å…·ä½“çš„åŠ è¼‰éç¨‹åƒè€ƒäº† Adrian Sampson åšå®¢ <a href=http://adriansampson.net/blog/clangpass.html>Run an LLVM Pass Automatically with Clang</a> ä¸­æåˆ°çš„æ“ä½œã€‚</li></ul><h1 id=å·¥ä½œæµç¨‹>å·¥ä½œæµç¨‹</h1><h2 id=æº–å‚™å·¥ä½œ>æº–å‚™å·¥ä½œ</h2><p>å°‡ç³»çµ±ä¸­è‡ªå¸¶çš„ llvm å’Œ clang éƒ½å¸è¼‰æ‰ï¼Œä¿è­‰ llvm å’Œ clang ç‰ˆæœ¬çš„ä¸€è‡´æ€§ï¼ˆéå¸¸é‡è¦ï¼‰ï¼Œå³ä¿è­‰ä½¿ç”¨çš„ clang å’Œ ç·¨è­¯å‡ºçš„ Pass çš„å‹•æ…‹éˆæ¥åº«æ–‡ä»¶ .so çš„ä¸€è‡´æ€§ã€‚</p><p>ä¸‹è¼‰ LLVM å¸¶æœ‰ clang çš„æºç¢¼ï¼Œè§£å£“ç¸®åˆ°æŸå€‹ç›®éŒ„ï¼Œæˆ‘è§£å£“åˆ°äº† <em>~/Projects/llvm-3.7.0.src</em> ã€‚å¦‚æœæ²’æœ‰çš„è©±å¯ä»¥ä¸‹è¼‰å°æ‡‰ç‰ˆæœ¬çš„ clang æºç¢¼æ”¾åˆ° llvm ä¸‹çš„ tools ç›®éŒ„ä¸‹é¢ï¼Œå…·é«”åƒè€ƒé€™å€‹æ•™ç¨‹ï¼š <a href=http://clang.llvm.org/get_started.html>Getting Started: Building and Running Clang</a> ã€‚</p><p>æ‡‰è©²æ˜¯ä½¿ç”¨ä¸‹é¢çš„å¹¾å€‹å‘½ä»¤ç·¨è­¯ä¸‹é …ç›®ï¼š</p><pre><code>mkdir build
cd build
../configure
cmake ..
`&lt;/pre&gt;

ç„¶å¾ŒåŸ·è¡Œ `make` æˆ–è€… `make -jn` ï¼ˆn çˆ²ä¸¦è¡Œç·¨è­¯åƒæ•¸ï¼Œæˆ‘çš„ CPU æ˜¯ _4 æ ¸ Intel(R) Xeon(R) CPU E3-1225 V2 @ 3.20GHz_ ï¼Œä½¿ç”¨äº† `make -j2`ï¼Œå› çˆ²é‚„è¦åŒæ™‚åšå…¶ä»–äº‹æƒ…ï¼‰ã€‚

ç·¨è­¯å®Œæˆå¾Œå°±å¯ä»¥ä½¿ç”¨ `make install` é€²è¡Œå®‰è£äº†ã€‚ç”±æ–¼ Ubuntu çš„åº«ä¸­è‡ªå¸¶ clang æ˜¯ 3.6 ç‰ˆï¼Œæ‰€ä»¥ä¸€é–‹å§‹é€™è£ç¹äº†ä¸€äº›å½è·¯ã€‚

## å°‡ä¸€å€‹ C æ–‡ä»¶ç·¨è­¯æˆ LLVM çš„ Bitcode

`clang -emit-llvm -c hello.c -o hello.bc`

_hello.c_

&lt;pre&gt;`#include &quot;stdio.h&quot;

int main()
{
  int a = 0;

  if (a == 1)
    return 0;

  if (a == 2)
    return 0;

  if (a == 3)
    return 0;

  return 0;
}
`&lt;/pre&gt;

## è‡ªå®šç¾© LLVM Pass

é€™éƒ¨åˆ†ç¶²çµ¡ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œå°±ä¸å¤šèªªäº†ï¼Œæ•™ç¨‹éƒ½æ¯”è¼ƒè©³ç´°ã€‚

æˆ‘å¯¦ç¾äº†ä¸€å€‹ FunctionPassï¼Œä¸»è¦å°±æ˜¯çµ¦æ¯å€‹ main å‡½æ•¸ä¸­çš„ BasicBlock æ·»åŠ ä¸Šåå­—ï¼Œç„¶å¾Œæ’å…¥ä¸€æ¢æ‰“å°æŒ‡ä»¤ï¼Œæ‰“å°å‡ºé€™å€‹åå­—å’Œè¿·ä¹‹æ•¸å­— 42 ã€‚

ä»£ç¢¼æ”¾åœ¨æœ€å¾Œå§ï¼Œç•¢ç«Ÿæ¯”è¼ƒé•·ã€‚

[å¯¦ç¾ä»£ç¢¼](#PassCode)

æœ€å¾Œçš„è¨»å†Š Pass çš„éƒ¨åˆ†ï¼š

&lt;pre&gt;`char MyInstrument::ID = 0;
static RegisterPass&amp;lt;MyInstrument&amp;gt; Z(&quot;MyInstrument&quot;, &quot;MyInstrument Pass&quot;, false, false);

static void registerMyPass(const PassManagerBuilder &amp;amp;, legacy::PassManagerBase &amp;amp;PM) {
  PM.add(new MyInstrument());
}
static RegisterStandardPasses RegisterMyPass(PassManagerBuilder::EP_EarlyAsPossible, registerMyPass);
`&lt;/pre&gt;

## ç·¨è­¯è‡ªå®šç¾©çš„ LLVM Pass

ç”±æ–¼æ²’æœ‰æˆåŠŸçˆ² LLVM é …ç›®é…ç½®å¥½ [_Clion_(a c++ IDE)](https://www.jetbrains.com/clion/) cmake çš„ Makefile ï¼ˆé€™ä¸€é»æ˜¯ç”±æ–¼å° cmake å’Œ makefile ä¸ç­è§£çš„ç·£æ•…ï¼‰ï¼Œæ‰€ä»¥åªèƒ½æ¡ç”¨æŸç¨®æ–¹å¼ç¹éã€‚

å‡è¨­å·²ç¶“æŠŠ LLVM çš„æºç¢¼ä¸‹è¼‰åœ¨æŸå€‹ç›®éŒ„ï¼ŒæŠŠè‡ªå·±ä¿®æ”¹çš„ Pass æ–‡ä»¶è¤‡è£½åˆ° LLVM æºç¢¼æ¨¹ä¸‹ Pass çš„å°æ‡‰æ–‡ä»¶å¤¾ï¼Œç„¶å¾Œç·¨è­¯ã€‚

&lt;pre&gt;`cp ~/ClionProjects/LLVMPass/ListBasicBlock/ListBasicBlock.cpp ~/Projects/llvm-3.7.0.src/lib/Transforms/Mypass/Mypass.cpp;
cd ~/Projects/llvm-3.7.0.src/build/lib/Transforms/Mypass/;
make
`&lt;/pre&gt;

é€™æ¨£æœƒå¾—åˆ° _~/Projects/llvm-3.7.0.src/build/lib/LLVMMypass.so_ ã€‚

## åŸ·è¡Œè‡ªå®šç¾© Pass

&lt;pre&gt;`opt -load ~/Projects/llvm-3.7.0.src/build/lib/LLVMMypass.so -MyInstrument &amp;lt;hello.bc -o new_hello.bc
`&lt;/pre&gt;

## ç·¨è­¯å¾—åˆ°å¯åŸ·è¡Œæ–‡ä»¶

èª¿ç”¨ LLVM çš„éœæ…‹ç·¨è­¯å™¨ llcï¼Œ`llc new_hello.bc`ï¼Œç„¶å¾Œç·¨è­¯å¾—åˆ°å¯åŸ·è¡Œæ–‡ä»¶ _a.out_ï¼Œ`clang new_hello.s` ã€‚

## åŸ·è¡Œå¯åŸ·è¡Œæ–‡ä»¶

`./a.out` å¯ä»¥å¾—åˆ°è¼¸å‡º

&lt;pre&gt;`main_0  42 
main_02 42 
main_04 42 
main_06 42 
main_07 42 

`&lt;/pre&gt;

åˆ°æ­¤çˆ²æ­¢å°±åŸºæœ¬çµæŸäº†ï¼Œè‡³æ–¼å¦‚æœæŒ‰ç…§è‡ªå®šç¾©éœ€æ±‚ä¿®æ”¹ Pass æ˜¯å°±è¦ç¹¼çºŒå­¸ç¿’äº†ã€‚

* * *

## é™„éŒ„

### &lt;a name=&quot;PassCode&quot;/&gt;å¯¦ç¾ä»£ç¢¼

&lt;pre&gt;`//===- Mypass.cpp - Example code from &quot;Writing an LLVM Pass&quot; ---------------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file implements two versions of the LLVM &quot;Mypass&quot; pass described
// in docs/WritingAnLLVMPass.html
//
//===----------------------------------------------------------------------===//

#include &quot;llvm/Transforms/Instrumentation.h&quot;
#include &quot;llvm/ADT/Statistic.h&quot;
#include &quot;llvm/IR/Function.h&quot;
#include &quot;llvm/IR/Module.h&quot;
#include &quot;llvm/Pass.h&quot;
#include &quot;llvm/IR/BasicBlock.h&quot;
#include &quot;llvm/IR/DebugInfo.h&quot;
#include &quot;llvm/IR/DebugLoc.h&quot;
#include &quot;llvm/IR/IRBuilder.h&quot;
#include &quot;llvm/IR/InstIterator.h&quot;
#include &quot;llvm/IR/Instructions.h&quot;
#include &quot;llvm/IR/IntrinsicInst.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;
#include &amp;lt;llvm/IR/GlobalVariable.h&amp;gt;
#include &amp;lt;llvm/IR/LLVMContext.h&amp;gt;
#include &amp;lt;llvm/Pass.h&amp;gt;
#include &amp;lt;llvm/ADT/SmallVector.h&amp;gt;
#include &amp;lt;llvm/IR/CallingConv.h&amp;gt;
#include &amp;lt;llvm/IR/Constants.h&amp;gt;
#include &amp;lt;llvm/IR/DerivedTypes.h&amp;gt;
#include &amp;lt;llvm/IR/Function.h&amp;gt;
#include &amp;lt;llvm/IR/GlobalVariable.h&amp;gt;
#include &amp;lt;llvm/IR/IRPrintingPasses.h&amp;gt;
#include &amp;lt;llvm/IR/InlineAsm.h&amp;gt;
#include &amp;lt;llvm/IR/Instructions.h&amp;gt;
#include &amp;lt;llvm/IR/LLVMContext.h&amp;gt;
#include &amp;lt;llvm/IR/Module.h&amp;gt;
#include &amp;lt;llvm/Support/FormattedStream.h&amp;gt;
#include &amp;lt;llvm/Support/MathExtras.h&amp;gt;
#include &amp;lt;algorithm&amp;gt;
#include &quot;llvm/IR/Type.h&quot;
#include &quot;llvm/IR/DerivedTypes.h&quot;
#include &quot;llvm/IR/LegacyPassManager.h&quot;
#include &quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;
using namespace llvm;
using namespace llvm;

#define DEBUG_TYPE &quot;mypass&quot;

STATISTIC(MypassCounter, &quot;Counts number of functions greeted&quot;);

namespace {
    // MyInstrument - Try to construct a pass to instrument log information.
    struct MyInstrument : public FunctionPass {
        static char ID;

        MyInstrument() : FunctionPass(ID) {}

        Function * getPrintF(IRBuilder&amp;lt;&amp;gt; &amp;amp;Builder, Module *M) {

            const char *Name = &quot;printf&quot;;
            Function *F = M-&amp;gt;getFunction(Name);

            if (!F) {
                GlobalValue::LinkageTypes Linkage = Function::ExternalLinkage;
                FunctionType *Ty = FunctionType::get(Builder.getInt32Ty(), true);
                F = Function::Create(Ty, Linkage, Name, M);
            }

            return F;
        }
        void createPrintF(IRBuilder&amp;lt;&amp;gt; &amp;amp;Builder,
                          std::string Format,
                          ArrayRef&amp;lt;Value *&amp;gt; Values,
                          Module *M) {
            Value *FormatString = Builder.CreateGlobalStringPtr(Format);
            std::vector&amp;lt;Value *&amp;gt; Arguments;

            Arguments.push_back(FormatString);
            Arguments.insert(Arguments.end(), Values.begin(), Values.end());
            Builder.CreateCall(getPrintF(Builder, M), Arguments);
        }

        bool runOnFunction(Function&amp;amp; F) override {
            MypassCounter++;

            // å¦‚æœä¸æ˜¯ main å‡½æ•¸ï¼Œå°±ä¸åšè™•ç†
            if (F.getName().equals(&quot;main&quot;) == false)
            {
                return false;
            }

            // ç²å– printf å‡½æ•¸
            Module* m = F.getParent();
            Function* printFun = m-&amp;gt;getFunction(&quot;printf&quot;);
            if (nullptr == printFun)
            {
                errs() &amp;lt;&amp;lt; &quot;printf function not get.&quot; &amp;lt;&amp;lt; '\n';
            }

            ///////////////////////////////////////////
            Module* mod = F.getParent();

            BasicBlock * pb = nullptr;

            errs() &amp;lt;&amp;lt; &quot;Function is: &quot; &amp;lt;&amp;lt; F.getName() &amp;lt;&amp;lt; '\n';

            // æŒ‰ç…§å¦‚ä¸‹æ ¼å¼é‡å‘½å BasicBlock
            // Name each basic block in the format 'FunctionName_BasicBlockID'
            int count;
            count = 0;
            for (Function::iterator b: F)
            {
                pb = b;
                IRBuilder&amp;lt;&amp;gt; Builder(pb);
                b-&amp;gt;setName(F.getName() + &quot;_&quot; + Twine(count));
            }

            // ä¾æ¬¡åœ¨æ¯å€‹ BasicBlock è™•æ’å…¥æ‰“å°èªå¥
            count = 0;
            for (Function::iterator b : F)
            {
                pb = b;
                IRBuilder&amp;lt;&amp;gt; Builder(pb);
                Builder.SetInsertPoint(pb, pb-&amp;gt;begin());

                std::vector&amp;lt;Value *&amp;gt; ArgsV;

                Twine format(pb-&amp;gt;getName());

                format.concat(&quot; %d\n&quot;);
                //errs() &amp;lt;&amp;lt; format.str() &amp;lt;&amp;lt; '\n';
                std::string formatStr = pb-&amp;gt;getName().str();
                formatStr += &quot;\t%d \n&quot;;

                Value *FormatString = Builder.CreateGlobalStringPtr(formatStr);
                ArgsV.push_back(FormatString);
                ArgsV.push_back(Builder.getInt32(42));
                Builder.CreateCall(getPrintF(Builder, mod), ArgsV);

            }
            return true;
        }
    };
}

char MyInstrument::ID = 0;
static RegisterPass&amp;lt;MyInstrument&amp;gt; Z(&quot;MyInstrument&quot;, &quot;MyInstrument Pass&quot;, false, false);

static void registerMyPass(const PassManagerBuilder &amp;amp;,
                           legacy::PassManagerBase &amp;amp;PM) {
    PM.add(new MyInstrument());
}
static RegisterStandardPasses
        RegisterMyPass(PassManagerBuilder::EP_EarlyAsPossible,
                       registerMyPass);
</code></pre></div></article></main></body></html>