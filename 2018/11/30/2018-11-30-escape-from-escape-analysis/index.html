<!doctype html><html lang=zh-cn><head><title>Escape from escape analysis // ä¸æ˜¯è¿½é£å°‘å¹´</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="bef0rewind"><meta name=description content><link rel=stylesheet href=https://blog.formalscience.com/css/main.min.7399fa7ec2205ae468fae43bdd5857841a2cd7eb35f0c8562b0e111b9d44c95f.css><link rel=stylesheet href=/css/style.css><script src=/javascripts/audio-player.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Escape from escape analysis"><meta name=twitter:description content="1. é€ƒé€¸åˆ†æèƒŒæ™¯ Go è¯­è¨€é‡‡ç”¨äº†å¹¶å‘çš„ï¼ˆConcurrentï¼‰ã€éç§»åŠ¨çš„ï¼ˆNon-Movableï¼‰ã€éåˆ†ä»£çš„ï¼ˆNon-Generationalï¼‰ã€åŸºäºä¸‰è‰²ï¼ˆTri-colorï¼‰æ ‡è®°çš„åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰ç®—æ³•ï¼Œåªåœ¨ ç‰¹å®šé˜¶æ®µå¼€å¯å†™å±éšœï¼ˆwrite barrierï¼‰ã€‚ ç‰¹ç‚¹æ˜¯å…¨å±€åœé¡¿æ—¶é—´æ¯”è¾ƒå°‘ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹æ˜¯åå¾®ç§’çº§åˆ«çš„ã€‚
åƒåœ¾å›æ”¶ç®—æ³•é’ˆå¯¹çš„æ˜¯å †ï¼ˆheapï¼‰ä¸­çš„å†…å­˜ã€‚ ä¸ºäº†å‡å°‘åƒåœ¾å›æ”¶çš„æ—¶é—´æ¶ˆè€—ï¼ŒGo è¯­è¨€åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡é™æ€åˆ†æç®—æ³•å¯¹ç¨‹åºçš„ç»“æ„è¿›è¡Œåˆ†æï¼Œå°½å¯èƒ½è®²å¯¹è±¡åˆ†é…åœ¨æ ˆä¸Šï¼ˆå¦‚æœè¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåœ¨å®ƒå®šä¹‰çš„å‡½æ•°è¿”å›æ—¶å°±ç»“æŸçš„è¯ï¼‰ã€‚ è¿™ä¸€ç®—æ³•ä¹Ÿåˆ©ç”¨äº† Go è¯­è¨€åœ¨å‡½æ•°ä¼ é€’å‚æ•°æ—¶æ€»æ˜¯ä¼ é€’å‚æ•°çš„å€¼è¿™ä¸€ä¸ªè¯­è¨€ç‰¹æ€§ã€‚
è€Œé™æ€åˆ†æä¸æ€»æ˜¯å®Œå¤‡çš„ï¼Œä¼šæœ‰ä¸€äº›æœ¬æ¥å¯ä»¥åˆ†é…åœ¨æ ˆä¸Šçš„å¯¹è±¡è¢« Go çš„ç¼–è¯‘å™¨åˆ†é…åœ¨äº†å †ä¸Šã€‚ å¦‚è¿™ç¯‡æ–‡ç« ã€ŠGolang escape analysisã€‹æ‰€æè¿°çš„ä¸€äº›ä¾‹å­ä¸€æ ·ï¼Œæœ‰äº›å¯¹è±¡æœ¬æ¥å¯ä»¥é¿å…é€ƒé€¸ï¼ˆEscapeï¼ŒæŒ‡çš„æ˜¯å¯¹è±¡è¢«åˆ†é…åœ¨å †ä¸Šï¼‰ã€‚
å¯¹äºæŸäº›åœºæ™¯ï¼Œæˆ‘ä»¬ç¡®å®šä¸€ä¸ªå¯¹è±¡è‚¯å®šå¯ä»¥ï¼ˆä¹Ÿåº”å½“ï¼‰è¢«åˆ†é…åœ¨æ ˆä¸Šï¼Œä½†æ˜¯å®ƒå´é€ƒé€¸äº†ã€‚ è¿™æ ·åœ¨æŸäº›å…³é”®è·¯å¾„ä¸Šçš„é€ƒé€¸çš„å¯¹è±¡ä¼šé€ æˆå¤§é‡çš„åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚
2. Go ç‰ˆæœ¬ ä½¿ç”¨çš„ Go ç‰ˆæœ¬ä¸ºä»Šæ™šåˆšä» master åˆ†æ”¯ä¸Š pull ä¸‹çš„æºç ç›´æ¥æ„å»ºã€‚
ThinkPad-X1-Carbon:bin bef0rewind$ ./go version go version devel +42e8b9c3a4 Fri Nov 30 15:17:34 2018 +0000 darwin/amd64 3. ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // file: escape."><meta property="og:title" content="Escape from escape analysis"><meta property="og:description" content="1. é€ƒé€¸åˆ†æèƒŒæ™¯ Go è¯­è¨€é‡‡ç”¨äº†å¹¶å‘çš„ï¼ˆConcurrentï¼‰ã€éç§»åŠ¨çš„ï¼ˆNon-Movableï¼‰ã€éåˆ†ä»£çš„ï¼ˆNon-Generationalï¼‰ã€åŸºäºä¸‰è‰²ï¼ˆTri-colorï¼‰æ ‡è®°çš„åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰ç®—æ³•ï¼Œåªåœ¨ ç‰¹å®šé˜¶æ®µå¼€å¯å†™å±éšœï¼ˆwrite barrierï¼‰ã€‚ ç‰¹ç‚¹æ˜¯å…¨å±€åœé¡¿æ—¶é—´æ¯”è¾ƒå°‘ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹æ˜¯åå¾®ç§’çº§åˆ«çš„ã€‚
åƒåœ¾å›æ”¶ç®—æ³•é’ˆå¯¹çš„æ˜¯å †ï¼ˆheapï¼‰ä¸­çš„å†…å­˜ã€‚ ä¸ºäº†å‡å°‘åƒåœ¾å›æ”¶çš„æ—¶é—´æ¶ˆè€—ï¼ŒGo è¯­è¨€åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡é™æ€åˆ†æç®—æ³•å¯¹ç¨‹åºçš„ç»“æ„è¿›è¡Œåˆ†æï¼Œå°½å¯èƒ½è®²å¯¹è±¡åˆ†é…åœ¨æ ˆä¸Šï¼ˆå¦‚æœè¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåœ¨å®ƒå®šä¹‰çš„å‡½æ•°è¿”å›æ—¶å°±ç»“æŸçš„è¯ï¼‰ã€‚ è¿™ä¸€ç®—æ³•ä¹Ÿåˆ©ç”¨äº† Go è¯­è¨€åœ¨å‡½æ•°ä¼ é€’å‚æ•°æ—¶æ€»æ˜¯ä¼ é€’å‚æ•°çš„å€¼è¿™ä¸€ä¸ªè¯­è¨€ç‰¹æ€§ã€‚
è€Œé™æ€åˆ†æä¸æ€»æ˜¯å®Œå¤‡çš„ï¼Œä¼šæœ‰ä¸€äº›æœ¬æ¥å¯ä»¥åˆ†é…åœ¨æ ˆä¸Šçš„å¯¹è±¡è¢« Go çš„ç¼–è¯‘å™¨åˆ†é…åœ¨äº†å †ä¸Šã€‚ å¦‚è¿™ç¯‡æ–‡ç« ã€ŠGolang escape analysisã€‹æ‰€æè¿°çš„ä¸€äº›ä¾‹å­ä¸€æ ·ï¼Œæœ‰äº›å¯¹è±¡æœ¬æ¥å¯ä»¥é¿å…é€ƒé€¸ï¼ˆEscapeï¼ŒæŒ‡çš„æ˜¯å¯¹è±¡è¢«åˆ†é…åœ¨å †ä¸Šï¼‰ã€‚
å¯¹äºæŸäº›åœºæ™¯ï¼Œæˆ‘ä»¬ç¡®å®šä¸€ä¸ªå¯¹è±¡è‚¯å®šå¯ä»¥ï¼ˆä¹Ÿåº”å½“ï¼‰è¢«åˆ†é…åœ¨æ ˆä¸Šï¼Œä½†æ˜¯å®ƒå´é€ƒé€¸äº†ã€‚ è¿™æ ·åœ¨æŸäº›å…³é”®è·¯å¾„ä¸Šçš„é€ƒé€¸çš„å¯¹è±¡ä¼šé€ æˆå¤§é‡çš„åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚
2. Go ç‰ˆæœ¬ ä½¿ç”¨çš„ Go ç‰ˆæœ¬ä¸ºä»Šæ™šåˆšä» master åˆ†æ”¯ä¸Š pull ä¸‹çš„æºç ç›´æ¥æ„å»ºã€‚
ThinkPad-X1-Carbon:bin bef0rewind$ ./go version go version devel +42e8b9c3a4 Fri Nov 30 15:17:34 2018 +0000 darwin/amd64 3. ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // file: escape."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.formalscience.com/2018/11/30/2018-11-30-escape-from-escape-analysis/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-30T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-30T00:00:00+00:00"></head><body><header class=app-header><a href=https://blog.formalscience.com/><img class=app-header-avatar src=/avatar.jpg alt=bef0rewind></a>
<span class=app-header-title>ä¸æ˜¯è¿½é£å°‘å¹´</span><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/posts>Blogs</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/douban>è±†ç“£æ–‡ç« å¤‡ä»½</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/wechat-blogs>å¾®ä¿¡å…¬ä¼—å·</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/categories/>Categories</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/tags/>Tags</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/about/>About</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/feed.xml>RSS</a></nav><p>å½“ä½ åœ¨è¿½ç€é£ï¼Œé£ä¹Ÿåœ¨æ¨ç€ä½ </p><div class=app-header-social><a href=https://github.com/ronhuafeng target=_blank rel="noreferrer noopener me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>æˆ‘çš„ GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Escape from escape analysis</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Nov 30, 2018</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://blog.formalscience.com/tags/golang/>Golang</a></div></div></header><div class=post-content><h2 id=1-é€ƒé€¸åˆ†æèƒŒæ™¯>1. é€ƒé€¸åˆ†æèƒŒæ™¯</h2><p>Go è¯­è¨€é‡‡ç”¨äº†å¹¶å‘çš„ï¼ˆConcurrentï¼‰ã€éç§»åŠ¨çš„ï¼ˆNon-Movableï¼‰ã€éåˆ†ä»£çš„ï¼ˆNon-Generationalï¼‰ã€åŸºäºä¸‰è‰²ï¼ˆTri-colorï¼‰æ ‡è®°çš„åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰ç®—æ³•ï¼Œåªåœ¨ ç‰¹å®šé˜¶æ®µå¼€å¯å†™å±éšœï¼ˆwrite barrierï¼‰ã€‚
ç‰¹ç‚¹æ˜¯å…¨å±€åœé¡¿æ—¶é—´æ¯”è¾ƒå°‘ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹æ˜¯åå¾®ç§’çº§åˆ«çš„ã€‚</p><p>åƒåœ¾å›æ”¶ç®—æ³•é’ˆå¯¹çš„æ˜¯å †ï¼ˆheapï¼‰ä¸­çš„å†…å­˜ã€‚
ä¸ºäº†å‡å°‘åƒåœ¾å›æ”¶çš„æ—¶é—´æ¶ˆè€—ï¼ŒGo è¯­è¨€åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡é™æ€åˆ†æç®—æ³•å¯¹ç¨‹åºçš„ç»“æ„è¿›è¡Œåˆ†æï¼Œå°½å¯èƒ½è®²å¯¹è±¡åˆ†é…åœ¨æ ˆä¸Šï¼ˆå¦‚æœè¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåœ¨å®ƒå®šä¹‰çš„å‡½æ•°è¿”å›æ—¶å°±ç»“æŸçš„è¯ï¼‰ã€‚
è¿™ä¸€ç®—æ³•ä¹Ÿåˆ©ç”¨äº† Go è¯­è¨€åœ¨å‡½æ•°ä¼ é€’å‚æ•°æ—¶æ€»æ˜¯ä¼ é€’å‚æ•°çš„å€¼è¿™ä¸€ä¸ªè¯­è¨€ç‰¹æ€§ã€‚</p><p>è€Œé™æ€åˆ†æä¸æ€»æ˜¯å®Œå¤‡çš„ï¼Œä¼šæœ‰ä¸€äº›æœ¬æ¥å¯ä»¥åˆ†é…åœ¨æ ˆä¸Šçš„å¯¹è±¡è¢« Go çš„ç¼–è¯‘å™¨åˆ†é…åœ¨äº†å †ä¸Šã€‚
å¦‚è¿™ç¯‡æ–‡ç« ã€Š<a href=http://www.agardner.me/golang/garbage/collection/gc/escape/analysis/2015/10/18/go-escape-analysis.html>Golang escape analysis</a>ã€‹æ‰€æè¿°çš„ä¸€äº›ä¾‹å­ä¸€æ ·ï¼Œæœ‰äº›å¯¹è±¡æœ¬æ¥å¯ä»¥é¿å…é€ƒé€¸ï¼ˆEscapeï¼ŒæŒ‡çš„æ˜¯å¯¹è±¡è¢«åˆ†é…åœ¨å †ä¸Šï¼‰ã€‚</p><p>å¯¹äºæŸäº›åœºæ™¯ï¼Œæˆ‘ä»¬ç¡®å®šä¸€ä¸ªå¯¹è±¡è‚¯å®šå¯ä»¥ï¼ˆä¹Ÿåº”å½“ï¼‰è¢«åˆ†é…åœ¨æ ˆä¸Šï¼Œä½†æ˜¯å®ƒå´é€ƒé€¸äº†ã€‚
è¿™æ ·åœ¨æŸäº›å…³é”®è·¯å¾„ä¸Šçš„é€ƒé€¸çš„å¯¹è±¡ä¼šé€ æˆå¤§é‡çš„åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚</p><h2 id=2-go-ç‰ˆæœ¬>2. Go ç‰ˆæœ¬</h2><p>ä½¿ç”¨çš„ Go ç‰ˆæœ¬ä¸ºä»Šæ™šåˆšä» master åˆ†æ”¯ä¸Š pull ä¸‹çš„æºç ç›´æ¥æ„å»ºã€‚</p><pre tabindex=0><code>ThinkPad-X1-Carbon:bin bef0rewind$ ./go version
go version devel +42e8b9c3a4 Fri Nov 30 15:17:34 2018 +0000 darwin/amd64
</code></pre><h2 id=3-ç¤ºä¾‹>3. ç¤ºä¾‹</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// file: escape.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>BigTempObject</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>/// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>field1</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>causeEscape</span><span class=p>(</span><span class=nx>i</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>i</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>BigTempObject</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nb>println</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>obj</span> <span class=o>:=</span> <span class=nx>BigTempObject</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>addrObj</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>obj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>causeEscape</span><span class=p>(</span><span class=nx>addrObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨ <code>go run -gcflags="-m -m" escape.go</code> å¯ä»¥åœ¨è¿è¡Œæ—¶è¾“å‡ºé€ƒé€¸åˆ†æçš„ç»“æœã€‚</p><pre tabindex=0><code>./escape.go:10: cannot inline causeEscape: unhandled op TYPESW
./escape.go:19: cannot inline main: non-leaf function
./escape.go:10: leaking param: i
./escape.go:10:         from ... argument (arg to ...) at ./escape.go:15
./escape.go:10:         from *(... argument) (indirection) at ./escape.go:15
./escape.go:10:         from ... argument (passed to call[argument content escapes]) at ./escape.go:15
./escape.go:15: causeEscape ... argument does not escape
./escape.go:23: addrObj escapes to heap
./escape.go:23:         from addrObj (passed to call[argument escapes]) at ./escape.go:23
./escape.go:21: &amp;obj escapes to heap
./escape.go:21:         from addrObj (assigned) at ./escape.go:21
./escape.go:21:         from addrObj (interface-converted) at ./escape.go:23
./escape.go:21:         from addrObj (passed to call[argument escapes]) at ./escape.go:23
./escape.go:20: moved to heap: obj
(0x10904e0,0xc420080050)
</code></pre><p><code>obj</code> å¯ä»¥åˆ†é…åœ¨æ ˆä¸Šï¼Œå› ä¸ºåœ¨ <code>main</code> å‡½æ•°è¿”å›æ—¶ï¼ˆæ ˆé€€å‡ºï¼‰ï¼Œè¿™ä¸ªå˜é‡å ç”¨çš„ç©ºé—´å°±å¯ä»¥å®‰å…¨è¢«ç”¨åœ¨å…¶ä»–åœ°æ–¹äº†ã€‚
ä½†æ˜¯ â€œ./escape.go:20: moved to heap: objâ€ è¯´æ˜ <code>obj</code> è¢«åˆ†é…åœ¨äº†å †ä¸Šã€‚</p><h2 id=4-å°æŠ€å·§>4. å°æŠ€å·§</h2><p>å¦‚ä½•æ”¹å˜è¿™ä¸ªåˆ†æç»“æœï¼Œéœ€è¦ä¸€ç‚¹å°æŠ€å·§ã€‚</p><p>å…³é”®è¯æ˜¯ <code>uintptr</code> ç±»å‹ã€‚
Go è¯­è¨€ä¸­å¯¹ <code>uintptr</code> æ˜¯è¿™æ ·æè¿°çš„ï¼š</p><blockquote><p>uintptr is an integer type that is large enough to hold the bit pattern of any pointer.</p></blockquote><p>æ¯”å¦‚åœ¨ 64-bit Linux ç³»ç»Ÿä¸Š <code>uintptr</code> è¢«å®šä¹‰æˆä¸ºäº† <code>uint64</code>ã€‚
Go ä¸­åˆæ³•çš„ç±»å‹è½¬æ¢ä¸ºï¼š<code>normal pointer</code> âŸ· <code>unsafe.Pointer</code> âŸ· <code>uintptr</code> ã€‚
å› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢çš„ç¨‹åºä¸­çš„ <code>addrObj</code> è½¬æ¢ä¸º <code>uintptr</code>ã€‚
è¿™æ · Go ç¼–è¯‘å™¨ä¸å†è®¤ä¸º <code>addrObj</code> åŒåé¢å‡½æ•° <code>causeEscape</code> ä½¿ç”¨çš„å‚æ•° <code>i</code> å­˜åœ¨å¼•ç”¨å…³ç³»ï¼Œä»è€Œç»•è¿‡ Escape Analysis Algorithm ã€‚
ä¸ºäº†é˜²æ­¢åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ <code>obj</code> è¢«å›æ”¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>obj.field1 = 0</code> æ¥ä¿æŒ <code>obj</code> æ´»è·ƒã€‚</p><p>ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;unsafe&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>BigTempObject</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>/// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>field1</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>causeEscape</span><span class=p>(</span><span class=nx>i</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>i</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>BigTempObject</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nb>println</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>obj</span> <span class=o>:=</span> <span class=nx>BigTempObject</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>addrObj</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>obj</span>
</span></span><span class=line><span class=cl>	<span class=nx>intAddr</span> <span class=o>:=</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>addrObj</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nf>causeEscape</span><span class=p>((</span><span class=o>*</span><span class=nx>BigTempObject</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>intAddr</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>	<span class=nx>obj</span><span class=p>.</span><span class=nx>field1</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨ <code>go run -gcflags="-m -m" escape.go</code> è¿è¡Œç»“æœï¼š</p><pre tabindex=0><code>./escape.go:13: cannot inline causeEscape: unhandled op TYPESW
./escape.go:22: cannot inline main: non-leaf function
./escape.go:13: leaking param: i
./escape.go:13:         from ... argument (arg to ...) at ./escape.go:18
./escape.go:13:         from *(... argument) (indirection) at ./escape.go:18
./escape.go:13:         from ... argument (passed to call[argument content escapes]) at ./escape.go:18
./escape.go:18: causeEscape ... argument does not escape
./escape.go:26: (*BigTempObject)(unsafe.Pointer(intAddr)) escapes to heap
./escape.go:26:         from (*BigTempObject)(unsafe.Pointer(intAddr)) (passed to call[argument escapes]) at ./escape.go:26
./escape.go:24: main &amp;obj does not escape
(0x10904e0,0xc42003bf70)
</code></pre><p>å¯ä»¥çœ‹åˆ° <code>obj</code> ä¸å†é€ƒé€¸ï¼Œä¸»è¦æ˜¯ <code>intAddr</code> ä¸­æ–­äº†é€ƒé€¸åˆ†æç®—æ³•æ„å»ºçš„æŒ‡é’ˆä¾èµ–å…³ç³»ï¼ˆè¡¨ç¤ºä¸ºä¸€ä¸ªæœ‰å‘å›¾ï¼‰ã€‚</p><h2 id=5-ä¸€ç‚¹æ„Ÿæƒ³>5. ä¸€ç‚¹æ„Ÿæƒ³</h2><p>æˆ‘ä»¬å¯ä»¥åšåˆ°ä¸ä»£è¡¨ä¸€å®šå»åšï¼Œæœ‰é£é™©ä¹Ÿä¸ä»£è¡¨ç¦åŒºï¼Œé‡‡å–ä»€ä¹ˆæ ·çš„è¡ŒåŠ¨æ˜¯ä¸ªäººæƒè¡¡åçš„é€‰æ‹©ã€‚<br>ä»€ä¹ˆåŸå› å¯¼è‡´äº†äººä»¬åšäº†ä¸åŒçš„é€‰æ‹©ï¼Œè€Œäººä»¬ä¸åŒçš„é€‰æ‹©åˆå¯¼è‡´äº†ä»€ä¹ˆç»“æœï¼Ÿ<br>å¤šæ ·æ€§æ˜¯è¿™ä¸ªä¸–ç•Œçš„ç°çŠ¶ï¼Œé»‘æš—é¢ä¸å…‰æ˜é¢åŒåœ¨ã€‚
May the force be with you.</p></div></article></main></body></html>