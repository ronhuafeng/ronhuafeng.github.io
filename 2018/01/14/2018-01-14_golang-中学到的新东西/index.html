<!doctype html><html lang=zh-cn><head><title>Golang ä¸­å­¦åˆ°çš„æ–°ä¸œè¥¿ // ä¸æ˜¯è¿½é£å°‘å¹´</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="bef0rewind"><meta name=description content><link rel=stylesheet href=https://blog.formalscience.com/css/main.min.7399fa7ec2205ae468fae43bdd5857841a2cd7eb35f0c8562b0e111b9d44c95f.css><link rel=stylesheet href=/css/style.css><script src=/javascripts/audio-player.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang ä¸­å­¦åˆ°çš„æ–°ä¸œè¥¿"><meta name=twitter:description content="æ•°æ®ç±»å‹ string ç±»å‹ string ç±»å‹ä½¿ç”¨ 2 ä¸ª wordï¼ˆ64 bit ç³»ç»Ÿä¸º 8 byte * 2ï¼‰è¡¨ç¤ºï¼šä¸€ä¸ª word æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘å­—ç¬¦ä¸²å­˜å‚¨åŒºåŸŸï¼›ä¸€ä¸ª word è¡¨ç¤ºé•¿åº¦æ•°æ®ã€‚
slice $\leftrightarrow$ unsafe.Pointer 1 2 s := make([]byte, 200) ptr := unsafe.Pointer(&s[0]) 1 2 var ptr unsafe.Pointer s := ((*[1<<10]byte)(ptr))[:200] or
1 2 3 4 5 6 7 8 var ptr unsafe.Pointer var s1 = struct { addr uintptr len int cap int }{ptr, length, length} s := *(*[]byte)(unsafe.Pointer(&s1)) or
1 2 3 4 5 var o []byte sliceHeader := (*reflect."><meta property="og:title" content="Golang ä¸­å­¦åˆ°çš„æ–°ä¸œè¥¿"><meta property="og:description" content="æ•°æ®ç±»å‹ string ç±»å‹ string ç±»å‹ä½¿ç”¨ 2 ä¸ª wordï¼ˆ64 bit ç³»ç»Ÿä¸º 8 byte * 2ï¼‰è¡¨ç¤ºï¼šä¸€ä¸ª word æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘å­—ç¬¦ä¸²å­˜å‚¨åŒºåŸŸï¼›ä¸€ä¸ª word è¡¨ç¤ºé•¿åº¦æ•°æ®ã€‚
slice $\leftrightarrow$ unsafe.Pointer 1 2 s := make([]byte, 200) ptr := unsafe.Pointer(&s[0]) 1 2 var ptr unsafe.Pointer s := ((*[1<<10]byte)(ptr))[:200] or
1 2 3 4 5 6 7 8 var ptr unsafe.Pointer var s1 = struct { addr uintptr len int cap int }{ptr, length, length} s := *(*[]byte)(unsafe.Pointer(&s1)) or
1 2 3 4 5 var o []byte sliceHeader := (*reflect."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.formalscience.com/2018/01/14/2018-01-14_golang-%E4%B8%AD%E5%AD%A6%E5%88%B0%E7%9A%84%E6%96%B0%E4%B8%9C%E8%A5%BF/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-14T11:53:30+00:00"><meta property="article:modified_time" content="2018-01-14T11:53:30+00:00"></head><body><header class=app-header><a href=https://blog.formalscience.com/><img class=app-header-avatar src=/avatar.jpg alt=bef0rewind></a>
<span class=app-header-title>ä¸æ˜¯è¿½é£å°‘å¹´</span><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/posts>Blogs</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/douban>è±†ç“£æ–‡ç« å¤‡ä»½</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/wechat-blogs>å¾®ä¿¡å…¬ä¼—å·</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/categories/>Categories</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/tags/>Tags</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/about/>About</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/feed.xml>RSS</a></nav><p>å½“ä½ åœ¨è¿½ç€é£ï¼Œé£ä¹Ÿåœ¨æ¨ç€ä½ </p><div class=app-header-social><a href=https://github.com/ronhuafeng target=_blank rel="noreferrer noopener me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>æˆ‘çš„ GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Golang ä¸­å­¦åˆ°çš„æ–°ä¸œè¥¿</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 14, 2018</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://blog.formalscience.com/tags/golang/>Golang</a></div></div></header><div class=post-content><h1 id=æ•°æ®ç±»å‹>æ•°æ®ç±»å‹</h1><h2 id=string-ç±»å‹><code>string</code> ç±»å‹</h2><p><code>string</code> ç±»å‹ä½¿ç”¨ 2 ä¸ª wordï¼ˆ64 bit ç³»ç»Ÿä¸º 8 byte * 2ï¼‰è¡¨ç¤ºï¼šä¸€ä¸ª word æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘å­—ç¬¦ä¸²å­˜å‚¨åŒºåŸŸï¼›ä¸€ä¸ª word è¡¨ç¤ºé•¿åº¦æ•°æ®ã€‚</p><h2 id=slice-leftrightarrow-unsafepointer><code>slice</code> $\leftrightarrow$ <code>unsafe.Pointer</code></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>s</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>ptr</span> <span class=o>:=</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>s</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ptr</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span>
</span></span><span class=line><span class=cl><span class=nx>s</span> <span class=o>:=</span> <span class=p>((</span><span class=o>*</span><span class=p>[</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>10</span><span class=p>]</span><span class=kt>byte</span><span class=p>)(</span><span class=nx>ptr</span><span class=p>))[:</span><span class=mi>200</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>or</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ptr</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>s1</span> <span class=p>=</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>addr</span> <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl>    <span class=nx>len</span>  <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>cap</span>  <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}{</span><span class=nx>ptr</span><span class=p>,</span> <span class=nx>length</span><span class=p>,</span> <span class=nx>length</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>s</span> <span class=o>:=</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>[]</span><span class=kt>byte</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>s1</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>or</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>o</span> <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=nx>sliceHeader</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=nx>reflect</span><span class=p>.</span><span class=nx>SliceHeader</span><span class=p>)((</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>o</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=nx>sliceHeader</span><span class=p>.</span><span class=nx>Cap</span> <span class=p>=</span> <span class=nx>length</span>
</span></span><span class=line><span class=cl><span class=nx>sliceHeader</span><span class=p>.</span><span class=nx>Len</span> <span class=p>=</span> <span class=nx>length</span>
</span></span><span class=line><span class=cl><span class=nx>sliceHeader</span><span class=p>.</span><span class=nx>Data</span> <span class=p>=</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>ptr</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=map-å®ç°><code>map</code> å®ç°</h1><p>æ•´ä¸ªé¡µé¢çš„å†…å®¹å¯¹æˆ‘æ¥è¯´éƒ½æ˜¯æ–°çš„ï¼šhttps://tiancaiamao.gitbooks.io/go-internals/content/zh/02.3.html
ä¸è¿‡è¿™ä¸ªé¡µé¢æè¿°çš„å†…å®¹å’Œæœ€æ–°çš„ Golang source æœ‰ä¸€å®šå·®åˆ«ã€‚</p><p>è¯» <code>HashMap</code> çš„å®ç°ï¼Œé‡Œé¢çš„ä¸€äº›æ ¸å¿ƒå…³é”®è¯ï¼š<code>bucket</code>ã€<code>overflow</code> è®©æˆ‘ç†è§£èµ·æ¥æœ‰äº›å›°éš¾ã€‚æŸ¥è¯¢ <code>HashMap</code> ç›¸å…³çš„ä¸€äº›èµ„æ–™åæœ‰äº†è¿›ä¸€æ­¥äº†è§£ã€‚</p><ol><li><code>bucket</code> ä¸€èˆ¬ä½¿ç”¨æŸç§ <code>array</code> ç®¡ç†ï¼Œä» <code>key</code> ç»è¿‡ <code>hash-function</code> æ˜ å°„çš„ <code>hash-value</code>ï¼ˆå¯èƒ½æˆªå–ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥è§†ä½œ sub-hashï¼Œæˆ‘è‡ªå·±ç¼–çš„ï¼‰ä½œä¸º <code>index</code> ç›´æ¥å¾—åˆ°ã€‚ä¸€ä¸ª <code>bucket</code> ä¸­å¯èƒ½åŒ…å«å¤šä¸ªä¸åŒçš„ <code>hash-value</code> ï¼Œå®ƒä»¬æˆªå–é‚£ä¸€éƒ¨åˆ†å¾—åˆ°çš„ <code>index</code> ç›¸åŒã€‚å› æ­¤ <code>bucket</code> ä¼šç”¨ä¸€ä¸ªæ•°æ®ç»“æ„ç®¡ç†è¿™äº›å†²çªçš„å€¼ï¼Œå¯èƒ½æ˜¯ <code>linked-list</code> æˆ–è€… <code>tree-map</code> ä¹‹ç±»çš„ã€‚è¿™äº›å†…éƒ¨çš„æ•°æ®ç»“æ„ä¸­çš„ <code>node</code> å­˜å‚¨ç€çœŸæ­£å¯¹åº” <code>map</code> çš„ <code>key\value</code> å¯¹(pair)ã€‚</li><li>å¦‚æœ <code>bucket</code> å¤ªæ»¡äº†ï¼Œæ¯”å¦‚å…ƒç´ çš„æ•°é‡è¶…è¿‡ <code>bucket</code> æ•°é‡ä¸€å®šå€æ•°ï¼ˆ<code>load factor</code>ï¼‰ï¼Œåˆ™ä¼šè¿›è¡Œæ‰©å®¹ï¼Œæ‰€æœ‰å…ƒç´ éƒ½è¢« <code>rehashed</code> åˆ°ä¸€ä¸ªæ–°çš„å€¼ã€‚</li><li>é‡‡ç”¨è¿™ç§æ–¹å¼å®ç° <code>HashMap</code>ï¼Œ<code>bucket</code> å¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼š</li></ol><ul><li><strong>Direct chaining</strong> åªå­˜ä¸€ä¸ªæŒ‡å‘å†²çªå…ƒç´ é›†åˆçš„ <code>header</code></li><li><strong>Seperate Chaining</strong> åœ¨ <code>bucket</code> å­˜ä¸€éƒ¨åˆ†ï¼ˆä¸€ä¸ªï¼‰å…ƒç´ é›†åˆï¼ˆGolang <code>HashMap</code> å®ç°é‡Œæ”¾äº† 8 ä¸ªï¼‰ï¼Œå’Œä¸€ä¸ªæŒ‡å‘å‰©ä¸‹å†²çªå…ƒç´ é›†åˆçš„ <code>header</code></li></ul><ol start=4><li>ä¸Šé¢ <code>header</code> æŒ‡å‘çš„å…ƒç´ é›†åˆå« <code>overflow list</code> æˆ–è€… <code>overflow some-other-data-structure</code></li></ol><p>æœ‰äº†è¿™äº›èƒŒæ™¯åï¼Œçœ‹ä»£ç åº”è¯¥ä¼šæ¯”è¾ƒæ¸…æ™°äº†ã€‚</p><p>ç›®å‰ Golang ä¸­çš„ <code>bucket</code> æ˜¯ä¸º <code>insert</code> æ“ä½œä¼˜åŒ–çš„ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½™ä½ç½®å°±å¯ä»¥æ’å…¥ï¼Œä½†æ˜¯åˆ é™¤çš„æ—¶å€™è¦æŠŠæ‰€æœ‰ç›¸åŒ <code>key</code> çš„å…ƒç´ éƒ½åˆ æ‰ï¼Œè¦éå† <code>bucket</code> çš„ <code>overflow</code> é›†åˆã€‚</p><p>å¦‚æœ key æˆ–è€… value å°äº 128 å­—èŠ‚ï¼Œé‚£ä¹ˆå®ƒä»¬æ˜¯ç›´æ¥åœ¨ <code>bucket</code> å­˜å‚¨å€¼ï¼Œå¦åˆ™å­˜æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆã€‚</p><h1 id=nil-è¯­ä¹‰><code>nil</code> è¯­ä¹‰</h1><p>æŒ‰ç…§ Golang è§„èŒƒï¼Œä»»ä½•ç±»å‹åœ¨æœªåˆå§‹åŒ–æ—¶éƒ½å¯¹åº”ä¸€ä¸ªé›¶å€¼ï¼š</p><ul><li><code>bool</code> $\rightarrow$ <code>true</code></li><li><code>integer</code> $\rightarrow$ <code>0</code></li><li><code>string</code> $\rightarrow$ <code>""</code></li><li><code>pointer</code>/<code>function</code>/<code>interface</code>/<code>slice</code>/<code>channel</code>/<code>map</code> $\rightarrow$ <code>nil</code></li></ul><h2 id=å…³äº-interface>å…³äº <code>interface{}</code></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>v</span> <span class=o>*</span><span class=nx>T</span>           <span class=c1>// v == nil
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>i</span> <span class=kd>interface</span><span class=p>{}</span>  <span class=c1>// i == nil
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>i</span> <span class=p>=</span> <span class=nx>v</span>              <span class=c1>// i != nil
</span></span></span></code></pre></td></tr></table></div></div><h2 id=å…³äº-channel>å…³äº <code>channel</code></h2><p>ä¸€äº›æ“ä½œè§„åˆ™ï¼š</p><ul><li>è¯»å†™ä¸€ä¸ª <code>nil</code> çš„ <code>channel</code> ä¼šç«‹å³é˜»å¡</li><li>è¯»ä¸€ä¸ªå…³é—­çš„ <code>channel</code> ä¼šç«‹åˆ»è¿”å›ä¸€ä¸ª <code>channel</code> å…ƒç´ ç±»å‹çš„é›¶å€¼ï¼Œå³ <code>chan int</code> ä¼šè¿”å› <code>0</code></li><li>å†™ä¸€ä¸ªå…³é—­çš„ <code>channel</code> ä¼šå¯¼è‡´ <code>panic</code></li></ul><h1 id=å‡½æ•°è°ƒç”¨>å‡½æ•°è°ƒç”¨</h1><h2 id=æ±‡ç¼–>æ±‡ç¼–</h2><p>å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ª Golang çš„å®˜æ–¹ä»‹ç»é¡µé¢ï¼šhttps://golang.org/doc/asm</p><p><strong>add.go</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>add</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=kt>uint64</span><span class=p>)</span> <span class=kt>uint64</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>add_amd64.s</strong> æˆ–ä½¿ç”¨å…¶ä»–å¹³å°åç¼€ï¼Œå’Œ <strong>add.go</strong> åœ¨åŒä¸€ä¸ªç›®å½•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>TEXT</span>    <span class=err>Â·</span><span class=nv>Add</span><span class=o>+</span><span class=mi>0</span><span class=p>(</span><span class=nv>SB</span><span class=p>),</span><span class=kc>$</span><span class=mi>0</span><span class=o>-</span><span class=mi>24</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nv>a</span><span class=o>+</span><span class=mi>0</span><span class=p>(</span><span class=nv>FP</span><span class=p>),</span><span class=nb>BX</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nv>b</span><span class=o>+</span><span class=mi>8</span><span class=p>(</span><span class=nv>FP</span><span class=p>),</span><span class=nb>BP</span>
</span></span><span class=line><span class=cl><span class=nf>ADDQ</span>    <span class=nb>BP</span><span class=p>,</span><span class=nb>BX</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nb>BX</span><span class=p>,</span><span class=nv>res</span><span class=o>+</span><span class=mi>16</span><span class=p>(</span><span class=nv>FP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>RET</span>     <span class=p>,</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=golang-è°ƒç”¨-c>Golang è°ƒç”¨ C</h2><p><strong>add.c</strong> ï¼Œå’Œ <strong>add.go</strong> åœ¨åŒä¸€ä¸ªç›®å½•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=err>Â·</span><span class=n>Add</span><span class=p>(</span><span class=n>uint64</span> <span class=n>a</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>b</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>ret</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FLUSH</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç¼–è¯‘è¿™ä¸ªåŒ…ï¼š<code>go install add</code></p><p>C æ–‡ä»¶ä¸­éœ€è¦åŒ…å« <code>runtime.h</code> å¤´æ–‡ä»¶ã€‚å› ä¸º Golang ä½¿ç”¨ç‰¹æ®Šå¯„å­˜å™¨å­˜æ”¾åƒå…¨å±€ <code>struct G</code> å’Œ <code>struct M</code> ï¼ŒåŒ…å«è¿™ä¸ªæ–‡ä»¶å¯ä»¥è®©æ‰€æœ‰é“¾æ¥åˆ° Go çš„ C æ–‡ä»¶æ„ŸçŸ¥è¿™ä¸€ç‚¹ï¼Œé¿å…ç¼–è¯‘å™¨ä½¿ç”¨è¿™äº›ç‰¹å®šçš„å¯„å­˜å™¨åšå…¶ä»–ç”¨é€”ã€‚</p><p>ä¸Šé¢ç¤ºä¾‹ä¸­è¿”å›å€¼ä¸ºç©ºï¼Œä½¿ç”¨ <code>ret</code> ä½œä¸ºè¿”å›å€¼ï¼Œ<code>FLUSH</code> åœ¨ <code>pkg/runtime/runtime.h</code> ä¸­å®šä¹‰ä¸º <code>USED()</code> ï¼Œé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰å¯¹æŸä¸ªå˜é‡çš„èµ‹å€¼æ“ä½œï¼ˆå› ä¸ºçœ‹ä¸åˆ°è¿™ä¸ªå˜é‡åœ¨åé¢å…¶ä»–åœ°æ–¹ä½¿ç”¨äº†ï¼‰ã€‚</p><h2 id=å‡½æ•°è°ƒç”¨æ—¶çš„å†…å­˜å¸ƒå±€>å‡½æ•°è°ƒç”¨æ—¶çš„å†…å­˜å¸ƒå±€</h2><p>Golang ä¸­ä½¿ç”¨çš„ C ç¼–è¯‘å™¨æ˜¯ plan9 çš„ C ç¼–è¯‘å™¨ï¼Œä¸ gcc æœ‰ä¸€å®šå·®å¼‚ã€‚
è¿™ä¸ªé¡µé¢ä¸­æœ‰éƒ¨åˆ†åŸºç¡€ä»‹ç»ï¼š
<a href=https://tiancaiamao.gitbooks.io/go-internals/content/zh/03.1.html>https://tiancaiamao.gitbooks.io/go-internals/content/zh/03.1.html</a></p><p>å¦‚æœè¿”å›å¤šä¸ªå€¼ï¼Œ<code>func f(a, b int) (d, e int)</code> å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre tabindex=0><code>slot for e
slot for d
b
a 
&lt;- SP
</code></pre><p>è°ƒç”¨åä¸º</p><pre tabindex=0><code>slot for e
slot for d
b
a &lt;- FP
PC &lt;- SP
f&#39;s stack
</code></pre><p>plan9 çš„ C æ±‡ç¼–å™¨å¯¹è¢«è°ƒç”¨å‡½æ•°çš„å‚æ•°å€¼çš„ä¿®æ”¹æ˜¯ä¼šè¿”å›åˆ°è°ƒç”¨å‡½æ•°ä¸­çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nb>BX</span><span class=p>,</span><span class=nv>d</span><span class=o>+</span><span class=mi>16</span><span class=p>(</span><span class=nv>FP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>...</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nb>BX</span><span class=p>,</span><span class=nv>e</span><span class=o>+</span><span class=mi>24</span><span class=p>(</span><span class=nv>FP</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=go-å…³é”®å­—><code>go</code> å…³é”®å­—</h1><p><code>f(1, 2, 3)</code> çš„æ±‡ç¼–:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>MOVL</span>    <span class=kc>$</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>(</span><span class=nb>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>MOVL</span>    <span class=kc>$</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>(</span><span class=nb>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>MOVL</span>    <span class=kc>$</span><span class=mi>3</span><span class=p>,</span> <span class=mi>8</span><span class=p>(</span><span class=nb>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>CALL</span>    <span class=nv>f</span><span class=p>(</span><span class=nv>SB</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>go f(1, 2, 3)</code> çš„æ±‡ç¼–ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>MOVL</span>    <span class=kc>$</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>(</span><span class=nb>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>MOVL</span>    <span class=kc>$</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>(</span><span class=nb>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>MOVL</span>    <span class=kc>$</span><span class=mi>3</span><span class=p>,</span> <span class=mi>8</span><span class=p>(</span><span class=nb>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>PUSHQ</span>   <span class=kc>$</span><span class=nv>f</span><span class=p>(</span><span class=nv>SB</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>PUSHQ</span>   <span class=kc>$</span><span class=mi>12</span>
</span></span><span class=line><span class=cl><span class=nf>CALL</span>    <span class=nv>runtime.newproc</span><span class=p>(</span><span class=nv>SB</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>POPQ</span>    <span class=nb>AX</span>
</span></span><span class=line><span class=cl><span class=nf>POPQ</span>    <span class=nb>AX</span>
</span></span></code></pre></td></tr></table></div></div><p><code>12</code> æ˜¯å‚æ•°å ç”¨çš„å¤§å°ï¼Œ<code>runtime.newproc</code> å‡½æ•°æ¥å—çš„å‚æ•°ä¸ºï¼šå‚æ•°å¤§å°ã€æ–°çš„ goroutine è¦è¿è¡Œçš„å‡½æ•°ã€å‡½æ•°çš„å‚æ•°ã€‚<code>runtime.newproc</code> ä¼šæ–°å»ºä¸€ä¸ªæ ˆç©ºé—´ï¼Œå°†æ ˆå‚æ•°çš„ 12 ä¸ªå­—èŠ‚å¤åˆ¶åˆ°æ–°çš„æ ˆç©ºé—´ï¼Œå¹¶è®©æ ˆæŒ‡é’ˆæŒ‡å‘å‚æ•°ã€‚å¯ä»¥çœ‹åš <code>runtime.newproc(size, f, args)</code> ã€‚</p><h1 id=defer-å…³é”®å­—><code>defer</code> å…³é”®å­—</h1><p><code>return x</code> ä¸æ˜¯åŸå­è¯­å¥ï¼Œå‡½æ•°æ‰§è¡Œé¡ºåºä¸ºï¼š</p><ol><li>ç»™è¿”å›å€¼èµ‹å€¼</li><li><code>defer</code> è°ƒç”¨</li><li><code>return</code></li></ol><p><code>defer</code> å®ç°å¯¹åº” <code>runtime.deferproc</code>ï¼Œå…¶å‡ºç°çš„åœ°æ–¹æ’å…¥æŒ‡ä»¤ <code>call runtime.deferproc</code> ï¼Œå‡½æ•°è¿”å›ä¹‹å‰çš„åœ°æ–¹ï¼Œæ’å…¥ <code>call runtime.deferreturn</code> ã€‚ goroutine çš„æ§åˆ¶ç»“æ„ä¸­æœ‰ä¸€å¼ è¡¨è®°å½• <code>defer</code>ï¼Œè¡¨ä»¥æ ˆè¡Œä¸ºè¿ä½œã€‚</p><h1 id=continuous-stack>Continuous Stack</h1><p>æˆ‘ä¹ŸåŸºæœ¬ç†è§£äº†æ€è·¯ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥çœ‹ï¼šhttps://tiancaiamao.gitbooks.io/go-internals/content/zh/03.5.html</p><p>æœ€åçš„ <code>runtime.lessstack</code> æœ‰äº›æ²¡çœ‹æ‡‚ã€‚</p><h1 id=é—­åŒ…>é—­åŒ…</h1><p>é—­åŒ…ä¸­å¼•ç”¨çš„å˜é‡ä¸èƒ½åœ¨æ ˆä¸Šåˆ†é…ï¼Œå¦åˆ™é—­åŒ…å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œæ ˆä¸Šå˜é‡çš„åœ°å€å°±å¤±æ•ˆäº†ã€‚</p><h2 id=é€ƒé€¸åˆ†æescape-analyze>é€ƒé€¸åˆ†æï¼ˆescape analyzeï¼‰</h2><p>Golang æœ‰ä¸ªç‰¹æ€§ï¼Œå¯ä»¥è‡ªåŠ¨è¯†åˆ«å“ªäº›å˜é‡åœ¨æ ˆä¸Šåˆ†é…ï¼Œå“ªäº›åœ¨å †ä¸Šåˆ†é…ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f</span><span class=p>()</span> <span class=o>*</span><span class=nx>Cursor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>c</span> <span class=nx>Cursor</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>X</span> <span class=p>=</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>    <span class=nf>noinline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>c</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>MOVQ</span>      <span class=kc>$</span><span class=nv>type.</span><span class=s>&#34;&#34;</span><span class=nv>.Cursor</span><span class=o>+</span><span class=mi>0</span><span class=p>(</span><span class=nv>SB</span><span class=p>),(</span><span class=nb>SP</span><span class=p>)</span>    <span class=o>//</span> <span class=err>å–å˜é‡</span><span class=nv>cçš„ç±»å‹</span><span class=err>ï¼Œä¹Ÿå°±æ˜¯</span><span class=nv>Cursor</span>
</span></span><span class=line><span class=cl><span class=nf>PCDATA</span>    <span class=kc>$</span><span class=mi>0</span><span class=p>,</span><span class=kc>$</span><span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=nf>PCDATA</span>    <span class=kc>$</span><span class=mi>1</span><span class=p>,</span><span class=kc>$</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>CALL</span>      <span class=p>,</span><span class=nv>runtime.new</span><span class=p>(</span><span class=nv>SB</span><span class=p>)</span>    <span class=o>//</span> <span class=err>è°ƒç”¨</span><span class=nv>newå‡½æ•°</span><span class=err>ï¼Œç›¸å½“äº</span><span class=nv>new</span><span class=p>(</span><span class=nv>Cursor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>PCDATA</span>    <span class=kc>$</span><span class=mi>0</span><span class=p>,</span><span class=kc>$</span><span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>      <span class=mi>8</span><span class=p>(</span><span class=nb>SP</span><span class=p>),</span><span class=nb>AX</span>    <span class=o>//</span> <span class=err>å–</span><span class=nv>c.Xçš„åœ°å€æ”¾åˆ°AXå¯„å­˜å™¨</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>      <span class=kc>$</span><span class=mi>500</span><span class=p>,(</span><span class=nb>AX</span><span class=p>)</span>    <span class=o>//</span> <span class=err>å°†</span><span class=nb>AX</span><span class=err>å­˜æ”¾çš„å†…å­˜åœ°å€çš„å€¼èµ‹ä¸º</span><span class=mi>500</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>      <span class=nb>AX</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=nv>.~r0</span><span class=o>+</span><span class=mi>24</span><span class=p>(</span><span class=nv>FP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>ADDQ</span>      <span class=kc>$</span><span class=mi>16</span><span class=p>,</span><span class=nb>SP</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡æŒ‡ä»¤è¾“å‡ºå“ªäº›å˜é‡é€ƒé€¸äº†ï¼š<code>go build --gcflags=-m main.go</code></p><h2 id=é—­åŒ…ç»“æ„ä½“>é—­åŒ…ç»“æ„ä½“</h2><p>é—­åŒ…å°†å‡½æ•°å’Œå®ƒå¼•ç”¨çš„ç¯å¢ƒè¡¨ç¤ºä¸ºä¸€ä¸ªç»“æ„ä½“ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Closure</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>F</span> <span class=kd>func</span><span class=p>()()</span> 
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=o>*</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ•´ä½“æ€è·¯æ˜¯è¿”å›é—­åŒ…çš„æ—¶å€™ï¼Œè¿”å›ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«é—­åŒ…è¿”å›å‡½æ•°çš„åœ°å€å’Œå¼•ç”¨çš„ç¯å¢ƒä¸­çš„å˜é‡åœ°å€ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f</span><span class=p>(</span><span class=nx>i</span> <span class=kt>int</span><span class=p>)</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>i</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=kc>$</span><span class=nv>type.int</span><span class=o>+</span><span class=mi>0</span><span class=p>(</span><span class=nv>SB</span><span class=p>),(</span><span class=nb>SP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>PCDATA</span>    <span class=kc>$</span><span class=mi>0</span><span class=p>,</span><span class=kc>$</span><span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=nf>PCDATA</span>    <span class=kc>$</span><span class=mi>1</span><span class=p>,</span><span class=kc>$</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>CALL</span>    <span class=p>,</span><span class=nv>runtime.new</span><span class=p>(</span><span class=nv>SB</span><span class=p>)</span>    <span class=o>//</span> <span class=err>æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™ä¸€æ®µå°±æ˜¯</span><span class=nv>i</span> <span class=err>=</span> <span class=nv>new</span><span class=p>(</span><span class=nv>int</span><span class=p>)</span>    
</span></span><span class=line><span class=cl><span class=nf>...</span>    
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=kc>$</span><span class=nv>type.struct</span> <span class=err>{</span> <span class=nv>F</span> <span class=nv>uintptr</span><span class=c1>; A0 *int }+0(SB),(SP)    // è¿™ä¸ªç»“æ„ä½“å°±æ˜¯é—­åŒ…çš„ç±»å‹</span>
</span></span><span class=line><span class=cl><span class=nf>...</span>
</span></span><span class=line><span class=cl><span class=nf>CALL</span>    <span class=p>,</span><span class=nv>runtime.new</span><span class=p>(</span><span class=nv>SB</span><span class=p>)</span>    <span class=o>//</span> <span class=err>æ¥ä¸‹æ¥ç›¸å½“äº</span> <span class=nv>new</span><span class=p>(</span><span class=nb>Cl</span><span class=nv>osure</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>PCDATA</span>    <span class=kc>$</span><span class=mi>0</span><span class=p>,</span><span class=kc>$</span><span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=mi>8</span><span class=p>(</span><span class=nb>SP</span><span class=p>),</span><span class=nb>AX</span>
</span></span><span class=line><span class=cl><span class=nf>NOP</span>    <span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=kc>$</span><span class=s>&#34;&#34;</span><span class=nv>.func</span><span class=err>Â·</span><span class=mi>001</span><span class=o>+</span><span class=mi>0</span><span class=p>(</span><span class=nv>SB</span><span class=p>),</span><span class=nb>BP</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nb>BP</span><span class=p>,(</span><span class=nb>AX</span><span class=p>)</span>                <span class=o>//</span> <span class=err>å‡½æ•°åœ°å€èµ‹å€¼ç»™</span><span class=nb>Cl</span><span class=nv>osureçš„Féƒ¨åˆ†</span>
</span></span><span class=line><span class=cl><span class=nf>NOP</span>    <span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=s>&#34;&#34;</span><span class=nv>.</span><span class=o>&amp;</span><span class=nv>i</span><span class=o>+</span><span class=mi>16</span><span class=p>(</span><span class=nb>SP</span><span class=p>),</span><span class=nb>BP</span>        <span class=o>//</span> <span class=err>å°†å †ä¸­</span><span class=nv>newçš„å˜é‡içš„åœ°å€èµ‹å€¼ç»™Closureçš„å€¼éƒ¨åˆ†</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nb>BP</span><span class=p>,</span><span class=mi>8</span><span class=p>(</span><span class=nb>AX</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>MOVQ</span>    <span class=nb>AX</span><span class=p>,</span><span class=s>&#34;&#34;</span><span class=nv>.~r1</span><span class=o>+</span><span class=mi>40</span><span class=p>(</span><span class=nv>FP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>ADDQ</span>    <span class=kc>$</span><span class=mi>24</span><span class=p>,</span><span class=nb>SP</span>
</span></span><span class=line><span class=cl><span class=nf>RET</span>    <span class=p>,</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=å¼•ç”¨>å¼•ç”¨</h1><ol><li><a href=https://tiancaiamao.gitbooks.io/go-internals>https://tiancaiamao.gitbooks.io/go-internals</a></li><li><a href=http://gki.informatik.uni-freiburg.de/teaching/ss11/theoryI/07_Hashing_Chaining.pdf>http://gki.informatik.uni-freiburg.de/teaching/ss11/theoryI/07_Hashing_Chaining.pdf</a></li></ol></div></article></main></body></html>