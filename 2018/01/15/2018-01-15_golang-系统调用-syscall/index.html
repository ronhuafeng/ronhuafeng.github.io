<!doctype html><html lang=zh-cn><head><title>Golang ç³»ç»Ÿè°ƒç”¨/Syscall // ä¸æ˜¯è¿½é£å°‘å¹´</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="bef0rewind"><meta name=description content><link rel=stylesheet href=https://blog.formalscience.com/css/main.min.7399fa7ec2205ae468fae43bdd5857841a2cd7eb35f0c8562b0e111b9d44c95f.css><link rel=stylesheet href=/css/style.css><script src=/javascripts/audio-player.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang ç³»ç»Ÿè°ƒç”¨/Syscall"><meta name=twitter:description content="æ¦‚è¿° å¾ˆå¤šå’Œç³»ç»Ÿç›¸å…³çš„å‡½æ•°éƒ½éœ€è¦è°ƒç”¨ç³»ç»Ÿ APIï¼Œä¾‹å¦‚è¯»å†™æ–‡ä»¶çš„å‡½æ•°ã€‚Golang å¯¹ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ¥å£è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº† Golang å‡½æ•°è®©ç”¨æˆ·è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š
1 2 func Read(fd int, p []byte) (n int, err error) func Write(fd int, p []byte) (n int, err error) åŒæ—¶ï¼ŒGolang ä¹Ÿæä¾›äº†å¯¹ Syscall çš„ç›´æ¥è°ƒç”¨æ”¯æŒï¼š
1 2 3 4 5 func Syscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err Errno) func Syscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err Errno) func RawSyscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err Errno) func RawSyscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err Errno) RawSyscall å’Œ RawSyscall6 æ˜¯å¯¹æ“ä½œç³»ç»Ÿ Syscall çš„ç›´æ¥è°ƒç”¨ï¼›Syscall å’Œ Syscall6 ä¼šåœ¨è°ƒç”¨æ“ä½œç³»ç»Ÿ Syscall å‰è°ƒç”¨ runtimeÂ·entersyscall ï¼Œåœ¨æ“ä½œç³»ç»Ÿ Syscall è¿”å›åè°ƒç”¨ runtimeÂ·exitsyscall ã€‚"><meta property="og:title" content="Golang ç³»ç»Ÿè°ƒç”¨/Syscall"><meta property="og:description" content="æ¦‚è¿° å¾ˆå¤šå’Œç³»ç»Ÿç›¸å…³çš„å‡½æ•°éƒ½éœ€è¦è°ƒç”¨ç³»ç»Ÿ APIï¼Œä¾‹å¦‚è¯»å†™æ–‡ä»¶çš„å‡½æ•°ã€‚Golang å¯¹ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ¥å£è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº† Golang å‡½æ•°è®©ç”¨æˆ·è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š
1 2 func Read(fd int, p []byte) (n int, err error) func Write(fd int, p []byte) (n int, err error) åŒæ—¶ï¼ŒGolang ä¹Ÿæä¾›äº†å¯¹ Syscall çš„ç›´æ¥è°ƒç”¨æ”¯æŒï¼š
1 2 3 4 5 func Syscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err Errno) func Syscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err Errno) func RawSyscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err Errno) func RawSyscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err Errno) RawSyscall å’Œ RawSyscall6 æ˜¯å¯¹æ“ä½œç³»ç»Ÿ Syscall çš„ç›´æ¥è°ƒç”¨ï¼›Syscall å’Œ Syscall6 ä¼šåœ¨è°ƒç”¨æ“ä½œç³»ç»Ÿ Syscall å‰è°ƒç”¨ runtimeÂ·entersyscall ï¼Œåœ¨æ“ä½œç³»ç»Ÿ Syscall è¿”å›åè°ƒç”¨ runtimeÂ·exitsyscall ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.formalscience.com/2018/01/15/2018-01-15_golang-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-syscall/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-15T20:59:11+00:00"><meta property="article:modified_time" content="2018-01-15T20:59:11+00:00"></head><body><header class=app-header><a href=https://blog.formalscience.com/><img class=app-header-avatar src=/avatar.jpg alt=bef0rewind></a>
<span class=app-header-title>ä¸æ˜¯è¿½é£å°‘å¹´</span><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/posts>Blogs</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/douban>è±†ç“£æ–‡ç« å¤‡ä»½</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/wechat-blogs>å¾®ä¿¡å…¬ä¼—å·</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/categories/>Categories</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/tags/>Tags</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/about/>About</a>
ğŸ˜Š<br><a class=app-header-menu-item href=/feed.xml>RSS</a></nav><p>å½“ä½ åœ¨è¿½ç€é£ï¼Œé£ä¹Ÿåœ¨æ¨ç€ä½ </p><div class=app-header-social><a href=https://github.com/ronhuafeng target=_blank rel="noreferrer noopener me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>æˆ‘çš„ GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Golang ç³»ç»Ÿè°ƒç”¨/Syscall</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 15, 2018</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://blog.formalscience.com/tags/golang/>Golang</a></div></div></header><div class=post-content><h1 id=æ¦‚è¿°>æ¦‚è¿°</h1><p>å¾ˆå¤šå’Œç³»ç»Ÿç›¸å…³çš„å‡½æ•°éƒ½éœ€è¦è°ƒç”¨ç³»ç»Ÿ APIï¼Œä¾‹å¦‚è¯»å†™æ–‡ä»¶çš„å‡½æ•°ã€‚Golang å¯¹ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ¥å£è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº† Golang å‡½æ•°è®©ç”¨æˆ·è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Read</span><span class=p>(</span><span class=nx>fd</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>p</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Write</span><span class=p>(</span><span class=nx>fd</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>p</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>åŒæ—¶ï¼ŒGolang ä¹Ÿæä¾›äº†å¯¹ Syscall çš„ç›´æ¥è°ƒç”¨æ”¯æŒï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Syscall</span><span class=p>(</span><span class=nx>trap</span><span class=p>,</span> <span class=nx>a1</span><span class=p>,</span> <span class=nx>a2</span><span class=p>,</span> <span class=nx>a3</span> <span class=kt>uintptr</span><span class=p>)</span> <span class=p>(</span><span class=nx>r1</span><span class=p>,</span> <span class=nx>r2</span> <span class=kt>uintptr</span><span class=p>,</span> <span class=nx>err</span> <span class=nx>Errno</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Syscall6</span><span class=p>(</span><span class=nx>trap</span><span class=p>,</span> <span class=nx>a1</span><span class=p>,</span> <span class=nx>a2</span><span class=p>,</span> <span class=nx>a3</span><span class=p>,</span> <span class=nx>a4</span><span class=p>,</span> <span class=nx>a5</span><span class=p>,</span> <span class=nx>a6</span> <span class=kt>uintptr</span><span class=p>)</span> <span class=p>(</span><span class=nx>r1</span><span class=p>,</span> <span class=nx>r2</span> <span class=kt>uintptr</span><span class=p>,</span> <span class=nx>err</span> <span class=nx>Errno</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RawSyscall</span><span class=p>(</span><span class=nx>trap</span><span class=p>,</span> <span class=nx>a1</span><span class=p>,</span> <span class=nx>a2</span><span class=p>,</span> <span class=nx>a3</span> <span class=kt>uintptr</span><span class=p>)</span> <span class=p>(</span><span class=nx>r1</span><span class=p>,</span> <span class=nx>r2</span> <span class=kt>uintptr</span><span class=p>,</span> <span class=nx>err</span> <span class=nx>Errno</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RawSyscall6</span><span class=p>(</span><span class=nx>trap</span><span class=p>,</span> <span class=nx>a1</span><span class=p>,</span> <span class=nx>a2</span><span class=p>,</span> <span class=nx>a3</span><span class=p>,</span> <span class=nx>a4</span><span class=p>,</span> <span class=nx>a5</span><span class=p>,</span> <span class=nx>a6</span> <span class=kt>uintptr</span><span class=p>)</span> <span class=p>(</span><span class=nx>r1</span><span class=p>,</span> <span class=nx>r2</span> <span class=kt>uintptr</span><span class=p>,</span> <span class=nx>err</span> <span class=nx>Errno</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>RawSyscall</code> å’Œ <code>RawSyscall6</code> æ˜¯å¯¹æ“ä½œç³»ç»Ÿ Syscall çš„ç›´æ¥è°ƒç”¨ï¼›<code>Syscall</code> å’Œ <code>Syscall6</code> ä¼šåœ¨è°ƒç”¨æ“ä½œç³»ç»Ÿ Syscall å‰è°ƒç”¨ <code>runtimeÂ·entersyscall</code> ï¼Œåœ¨æ“ä½œç³»ç»Ÿ Syscall è¿”å›åè°ƒç”¨ <code>runtimeÂ·exitsyscall</code> ã€‚</p><p>è¿™å››ä¸ªå‡½æ•°éƒ½æ˜¯ä½¿ç”¨æ±‡ç¼–è¯­è¨€å®ç°ï¼Œä»£ç å’Œå…·ä½“çš„ç¡¬ä»¶ä½“ç³»ç»“æ„å’Œæ“ä½œç³»ç»Ÿæœ‰å…³ã€‚<code>RawSyscall</code> å’Œ <code>RawSyscall6</code> çš„è¡Œä¸ºå’Œ C è¯­è¨€ä¸­ç³»ç»Ÿè°ƒç”¨å¾ˆç±»ä¼¼ï¼Œåœ¨è¿™é‡Œä¸å±•å¼€æè¿°ã€‚è€Œ <code>Syscall</code> å’Œ <code>Syscall6</code> çš„è¡Œä¸ºï¼ˆåœ¨è¿›è¡ŒçœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨å‰åæ’å…¥é¢å¤–æ“ä½œï¼‰ä¸ Golang çš„è°ƒåº¦å™¨å…³ç³»ç´§å¯†ï¼Œåœ¨ä¸‹é¢ä¼šè¿›è¡Œè¦ç‚¹æè¿°ã€‚</p><p><code>Syscall</code> çš„å…³é”®åœ¨äº <code>runtimeÂ·entersyscall</code> å’Œ <code>runtimeÂ·exitsyscall</code> ï¼Œè€Œ <code>runtimeÂ·entersyscall</code> è¿˜æœ‰ä¸€ä¸ªè¡Œä¸ºæœ‰éƒ¨åˆ†å·®å¼‚çš„ç‰ˆæœ¬ <code>runtimeÂ·entersyscallblock</code> ã€‚</p><h1 id=runtimeentersyscall><code>runtimeÂ·entersyscall</code></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>entersyscall</span><span class=p>(</span><span class=nx>dummy</span> <span class=kt>int32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>reentersyscall</span><span class=p>(</span><span class=nf>getcallerpc</span><span class=p>(),</span> <span class=nf>getcallersp</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>dummy</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>reentersyscall</span><span class=p>(</span><span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span> <span class=kt>uintptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Disable preemption because during this function g is in Gsyscall status,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// but can have inconsistent g-&gt;sched, do not let GC observe it.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span><span class=o>++</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Entersyscall must not call any function that might split/grow the stack.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (See details in comment above.)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Catch calls that might, by replacing the stack guard with something that
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// will trip any stack check and leaving a flag to tell newstack to die.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>stackguard0</span> <span class=p>=</span> <span class=nx>stackPreempt</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>throwsplit</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Leave SP around for GC and traceback.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>save</span><span class=p>(</span><span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>syscallsp</span> <span class=p>=</span> <span class=nx>sp</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>syscallpc</span> <span class=p>=</span> <span class=nx>pc</span>
</span></span><span class=line><span class=cl>	<span class=nf>casgstatus</span><span class=p>(</span><span class=nx>_g_</span><span class=p>,</span> <span class=nx>_Grunning</span><span class=p>,</span> <span class=nx>_Gsyscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_g_</span><span class=p>.</span><span class=nx>syscallsp</span> <span class=p>&lt;</span> <span class=nx>_g_</span><span class=p>.</span><span class=nx>stack</span><span class=p>.</span><span class=nx>lo</span> <span class=o>||</span> <span class=nx>_g_</span><span class=p>.</span><span class=nx>stack</span><span class=p>.</span><span class=nx>hi</span> <span class=p>&lt;</span> <span class=nx>_g_</span><span class=p>.</span><span class=nx>syscallsp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>systemstack</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>print</span><span class=p>(</span><span class=s>&#34;entersyscall inconsistent &#34;</span><span class=p>,</span> <span class=nf>hex</span><span class=p>(</span><span class=nx>_g_</span><span class=p>.</span><span class=nx>syscallsp</span><span class=p>),</span> <span class=s>&#34; [&#34;</span><span class=p>,</span> <span class=nf>hex</span><span class=p>(</span><span class=nx>_g_</span><span class=p>.</span><span class=nx>stack</span><span class=p>.</span><span class=nx>lo</span><span class=p>),</span> <span class=s>&#34;,&#34;</span><span class=p>,</span> <span class=nf>hex</span><span class=p>(</span><span class=nx>_g_</span><span class=p>.</span><span class=nx>stack</span><span class=p>.</span><span class=nx>hi</span><span class=p>),</span> <span class=s>&#34;]\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;entersyscall&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>enabled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>systemstack</span><span class=p>(</span><span class=nx>traceGoSysCall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// systemstack itself clobbers g.sched.{pc,sp} and we might
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// need them later when the G is genuinely blocked in a
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// syscall
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>save</span><span class=p>(</span><span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>sched</span><span class=p>.</span><span class=nx>sysmonwait</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>systemstack</span><span class=p>(</span><span class=nx>entersyscall_sysmon</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>save</span><span class=p>(</span><span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>p</span><span class=p>.</span><span class=nf>ptr</span><span class=p>().</span><span class=nx>runSafePointFn</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// runSafePointFn may stack split if run on this stack
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>systemstack</span><span class=p>(</span><span class=nx>runSafePointFn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>save</span><span class=p>(</span><span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>syscalltick</span> <span class=p>=</span> <span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>p</span><span class=p>.</span><span class=nf>ptr</span><span class=p>().</span><span class=nx>syscalltick</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>sysblocktraced</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>mcache</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>p</span><span class=p>.</span><span class=nf>ptr</span><span class=p>().</span><span class=nx>m</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=nx>atomic</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>p</span><span class=p>.</span><span class=nf>ptr</span><span class=p>().</span><span class=nx>status</span><span class=p>,</span> <span class=nx>_Psyscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>gcwaiting</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>systemstack</span><span class=p>(</span><span class=nx>entersyscall_gcwait</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>save</span><span class=p>(</span><span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Goroutines must not split stacks in Gsyscall status (it would corrupt g-&gt;sched).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// We set _StackGuard to StackPreempt so that first split stack check calls morestack.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Morestack detects this case and throws.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>stackguard0</span> <span class=p>=</span> <span class=nx>stackPreempt</span>
</span></span><span class=line><span class=cl>	<span class=nx>_g_</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span><span class=o>--</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>runtimeÂ·entersyscall</code> ä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ol><li>å£°æ˜å‡½æ•°ä¸º <code>NOSPLIT</code> ï¼Œä¸è§¦å‘æ ˆæ‰©å±•æ£€æŸ¥</li><li>ç¦æ­¢æŠ¢å </li><li>é€šè¿‡ <code>dummy</code> å‚æ•°è·å¾—è°ƒç”¨è€…çš„ <code>SP</code> å’Œ <code>PC</code> çš„å€¼ï¼Œå¹¶ä¿å­˜åˆ° goroutine çš„ <code>syscallsp</code> å’Œ <code>syscallpc</code> å­—æ®µã€‚åŒæ—¶è®°å½• <code>syscallstack</code> å’Œ <code>syscallguard</code> ï¼Œä½¿å¾—åƒåœ¾å›æ”¶å™¨åªå¯¹ç³»ç»Ÿè°ƒç”¨å‰çš„æ ˆè¿›è¡Œ <strong>mark-sweep</strong> ï¼ˆcgo æœºåˆ¶ä¹Ÿåˆ©ç”¨äº† <code>entersyscall</code> æ¥ä½¿å¾— cgo ä¸­è¿è¡Œçš„ä»£ç ä¸å—åƒåœ¾å›æ”¶æœºåˆ¶ç®¡ç†ï¼‰ã€‚</li><li>å°† goroutine çš„çŠ¶æ€åˆ‡æ¢åˆ° Gsyscall çŠ¶æ€ã€‚</li><li>å”¤é†’åå°çº¿ç¨‹ <code>sysmon</code> ï¼ˆè¿™ä¸ªçº¿ç¨‹ä¼šç›‘æ§æ‰§è¡Œ <code>syscall</code> çš„çº¿ç¨‹ï¼Œå¦‚æœè¶…è¿‡æŸä¸ªæ—¶é—´é˜ˆå€¼ï¼Œå°±ä¼šå°† M ä¸å¯¹åº”çš„ P è§£é™¤ç»‘å®šï¼‰ã€‚</li><li>ç½®ç©º M çš„ <code>mcache</code> ã€å°† P çš„ <code>m</code> å­—æ®µï¼Œåˆ‡æ¢ P çš„çŠ¶æ€åˆ° <code>Psyscall</code></li><li>æ£€æŸ¥æ˜¯å¦éœ€è¦åƒåœ¾å›æ”¶</li><li>é€šè¿‡ <code>g->stackguard0 = StackPreempt</code> ä½¿å¾—å‡ºç° <em>split stack</em> æ—¶å¯ä»¥é€šè¿‡ <code>morestack</code> æ•è·å¹¶æŠ›å‡ºé”™è¯¯</li><li>æ¢å¤æŠ¢å </li></ol><p>å¯ä»¥çœ‹åˆ° <code>reentersyscall</code> å¤šæ¬¡è°ƒç”¨ <code>save</code> ä¿å­˜ <code>pc</code> å’Œ <code>sp</code>ã€‚<code>save</code> æ›´æ–° <code>getg().sched</code> ä¸­çš„ <code>sp</code> å’Œ <code>pc</code> ï¼Œä½¿å¾—è°ƒç”¨ <code>gogo</code> çš„æ—¶å€™å¯ä»¥æ¢å¤ <code>pc</code> å’Œ <code>sp</code> ã€‚<code>reentersyscall</code> ä¸­ <code>save</code> çš„ç›®çš„éƒ½æ˜¯ä¸º goroutine è·³å›è¿™ä¸ª <code>syscall</code> è°ƒç”¨è€…æ‰§è¡Œ <code>syscall</code> æ—¶åˆ»çš„ <code>pc</code> å’Œ <code>sp</code>åšå‡†å¤‡ã€‚</p><p>éœ€è¦ç»§ç»­æ·±å…¥ï¼š</p><ol><li><code>StackPreempt</code></li><li><code>syscallstack</code> å’Œ <code>syscallguard</code> çš„å…·ä½“ä½œç”¨æ—¶æœº</li></ol><h1 id=runtimeentersyscallblock><code>runtimeÂ·entersyscallblock</code></h1><p>ä¸ <code>runtimeÂ·entersyscall</code> åŒºåˆ«åœ¨äºè¿™ä¸ªå‡½æ•°è®¤ä¸ºå½“å‰æ‰§è¡Œçš„ <code>syscall</code> ä¼šè¿è¡Œè¾ƒé•¿æ—¶é—´ï¼Œå› æ­¤åœ¨å‡½æ•°ä¸­ä¸»åŠ¨è¿›è¡Œäº† M å’Œ P çš„è§£é™¤ç»‘å®šï¼Œæ— éœ€ç­‰å¾… <code>sysmon</code> å¤„ç†ã€‚è§£é™¤ M å’Œ P ç»‘å®šçš„é€»è¾‘ç”± <code>entersyscallblock_handoff</code> å®ç°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>entersyscallblock_handoff</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>enabled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>traceGoSysCall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nf>traceGoSysBlock</span><span class=p>(</span><span class=nf>getg</span><span class=p>().</span><span class=nx>m</span><span class=p>.</span><span class=nx>p</span><span class=p>.</span><span class=nf>ptr</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>handoffp</span><span class=p>(</span><span class=nf>releasep</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=runtimeexitsyscall><code>runtimeÂ·exitsyscall</code></h1><p>ä¸»è¦å®ç°äº†ä» <code>syscall</code> çŠ¶æ€ä¸­æ¢å¤çš„åŠ¨ä½œï¼š</p><ol><li>å°è¯•è°ƒç”¨ <code>exitsyscallfast</code> ï¼Œå¦‚æœ M ä¸ P æ²¡æœ‰å®Œå…¨è§£é™¤ç»‘å®šï¼Œé‚£ä¹ˆè¯¥æ“ä½œä¼šå°† M å’Œ P é‡æ–°ç»‘å®šï¼›å¦åˆ™è·å–ä¸€ä¸ªç©ºé—²çš„ P ä¸å½“å‰ M ç»‘å®šã€‚å¦‚æœç»‘å®šæˆåŠŸï¼Œè¿”å› <code>True</code>ï¼Œå¦åˆ™è¿”å› <code>False</code> è¿›è¡Œåç»­æ­¥éª¤å¤„ç†ã€‚</li><li>å¦‚æœ <code>exitsyscallfast</code> è¿”å› <code>True</code> ï¼Œå‡½æ•°å°±ç›´æ¥è¿”å›ï¼›è¿”å› <code>False</code>ï¼Œåˆ™è¿›å…¥ <em>slow path</em> å°†å½“å‰ goroutine æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦ï¼Œå…·ä½“å®ç°ç”± <code>mcall(exitsyscall0)</code> å®ç°ã€‚</li></ol><p><code>exitsyscall0</code> è¿™ä¸ªå‡½æ•°æ¯”è¾ƒæ¸…æ™°ï¼Œåªæ˜¯å¯¹å…¶ä¸­ <code>dropg()</code> çš„ç›®çš„è¿˜æ²¡æƒ³æ¸…æ¥šã€‚</p><p><code>runtimeÂ·exitsyscall</code> çš„å‡½æ•°è¯´æ˜ä¸­æåˆ°çš„ <code>// Write barriers are not allowed because our P may have been stolen.</code> ä¹Ÿæ²¡æœ‰ææ¸…æ¥šï¼ŒçŸ¥é“å’Œ GC æœ‰ä¸€å®šå…³ç³»ã€‚</p><h1 id=å¼•ç”¨>å¼•ç”¨</h1><ol><li><a href=https://studygolang.com/articles/7005>https://studygolang.com/articles/7005</a></li></ol></div></article></main></body></html>